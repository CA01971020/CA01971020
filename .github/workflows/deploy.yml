on:
  schedule:
    - cron: "0 16 * * *" # JST 1:00 AM daily
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests python-dateutil
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate SVGs
        env:
          PROFILE_GH_TOKEN: ${{ secrets.PROFILE_GH_TOKEN }}
        run: |
          mkdir -p public
          python scripts/fetch_stats.py
          python scripts/summary.py
          python scripts/commits_monthly.py
          python scripts/streak.py
          python scripts/total_contributions.py

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          netlify deploy \
            --dir=public \
            --prod \
            --site=$NETLIFY_SITE_ID \
            --auth=$NETLIFY_AUTH_TOKEN

      - name: Notify LINE (Daily Deploy Success)
        if: success()
        env:
          LINE_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        run: |
          MESSAGE="GitHub Actions ÂÆöÊúü„Éá„Éó„É≠„Ç§ÂÆå‰∫ÜÔºÅ

          „ÉªSVG ÁîüÊàê OK
          „ÉªNetlify „Éá„Éó„É≠„Ç§ OK

          üóÇ Repo:
          ${{ github.repository }}

          ‚è± Trigger:
          ${{ github.event_name }}

          üîó Actions Run:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          üîó hii dev GitHub Profile
          https://github.com/CA01971020

          ‰ªäÊó•„ÇÇÂπ≥Â∏∏ÈÅãËª¢„Åß„Åô üëç"

          printf '%s' "$MESSAGE" | jq -Rs \
            --arg to "$LINE_USER_ID" \
            --arg text "$MESSAGE" \
            '{
              to: $to,
              messages: [
                { type: "text", text: $text }
              ]
            }' | curl -s -X POST https://api.line.me/v2/bot/message/push \
              -H "Authorization: Bearer $LINE_TOKEN" \
              -H "Content-Type: application/json" \
              -d @-

      - name: Notify LINE (Deploy Failed)
        if: failure()
        env:
          LINE_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
        run: |
          MESSAGE="‚ö†Ô∏è GitHub Actions „Éá„Éó„É≠„Ç§Â§±Êïó

          üóÇ Repo:
          ${{ github.repository }}

          ‚è± Trigger:
          ${{ github.event_name }}

          üîó Actions Run:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          „É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"

          printf '%s' "$MESSAGE" | jq -Rs \
            --arg to "$LINE_USER_ID" \
            --arg text "$MESSAGE" \
            '{
              to: $to,
              messages: [
                { type: "text", text: $text }
              ]
            }' | curl -s -X POST https://api.line.me/v2/bot/message/push \
              -H "Authorization: Bearer $LINE_TOKEN" \
              -H "Content-Type: application/json" \
              -d @-
